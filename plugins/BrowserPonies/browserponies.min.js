(function(){var a=function(d,c){for(var b in c){if(!(b in d)){d[b]=c[b]}}};a(String.prototype,{trim:function(){return this.replace(/^\s\s*/,"").replace(/\s\s*$/,"")},trimLeft:function(){return this.replace(/^\s\s*/,"")},trimRight:function(){return this.replace(/\s\s*$/,"")}});a(Array,{isArray:function(b){return Object.prototype.toString.call(b)==="[object Array]"}});a(Array.prototype,{indexOf:function(b,c){if(!c||c<0){c=0}for(;c<this.length;++c){if(this[c]===b){return c}}return -1}});a(Function.prototype,{bind:function(d){var b=this;var c=Array.prototype.slice.call(arguments,1);return function(){return b.apply(d,c.concat(Array.prototype.slice.call(arguments)))}}});a(Date,{now:function(){return new Date().getTime()}});if(typeof(console)==="undefined"){a(window,{console:{}})}a(window.console,{log:function(){}});a(window.console,{info:window.console.log,warn:window.console.log,error:window.console.log,trace:window.console.log,dir:window.console.log})})();var BrowserPonies=(function(){var a=9000000;var n=document.addEventListener?function(aI,aK,aJ){aI.addEventListener(aK,aJ,false)}:function(aI,aK,aJ){var aL="_eventHandlingWrapper" in aJ?aJ._eventHandlingWrapper:(aJ._eventHandlingWrapper=function(){var aM=window.event;if(!("stopPropagation" in aM)){aM.stopPropagation=function(){this.cancelBubble=true}}if(!("preventDefault" in aM)){aM.preventDefault=function(){this.returnValue=false}}if(!("target" in aM)){aM.target=aM.srcElement}return aJ.call(this,aM)});aI.attachEvent("on"+aK,aL)};var v=document.removeEventListener?function(aI,aK,aJ){aI.removeEventListener(aK,aJ,false)}:function(aI,aK,aJ){if("_eventHandlingWrapper" in aJ){aI.detachEvent("on"+aK,aJ._eventHandlingWrapper)}};var e="innerWidth" in window?function(){return{width:window.innerWidth,height:window.innerHeight}}:function(){return{width:document.documentElement.clientWidth,height:document.documentElement.clientHeight}};var j=function(aJ,aL,aK,aI){if(aJ.length>=aL){return aJ}aK=new Array(aL-aJ.length+1).join(aK);return aI?(aK+aJ):(aJ+aK)};var r=function(aL){var aN="";var aK=1;while(aL){var aI=/^([^%]*)%(-)?(0)?(\d+)?(?:\.(\d+)?)?([dfesj%])(.*)$/.exec(aL);if(!aI){aN+=aL;break}aN+=aI[1];aL=aI[7];var aM=aI[2]!=="-";var aP=aI[4]?parseInt(aI[4]):0;var aJ=aI[5]?parseInt(aI[5]):6;var aO=aM?(aI[3]||" "):" ";switch(aI[6]){case"d":aN+=j(parseInt(arguments[aK++]).toFixed(0),aP,aO,aM);break;case"f":aN+=j(parseFloat(arguments[aK++]).toFixed(aJ),aP,aO,aM);break;case"e":aN+=j(parseFloat(arguments[aK++]).toExponential(aJ),aP,aO,aM);break;case"s":aN+=j(String(arguments[aK++]),aP," ",aM);break;case"j":aN+=j(JSON.stringify(arguments[aK++]),aP," ",aM);break;case"%":aN+=j("%",aP," ",aM)}}return aN};var V=function(aJ,aK){for(var aI in aK){aJ[aI]=aK[aI]}return aJ};var d=function(aJ){var aI=Array.prototype.slice.call(arguments,1);return function(){return aJ.apply(this,aI.concat(Array.prototype.slice.call(arguments)))}};var W=function W(aJ){var aK=W.abs(aJ);var aI=W.FILE_REGEX.exec(aK);if(!aI){aI=W.NET_REGEX.exec(aK)}if(!aI){throw new URIError("Illegal URL: "+aJ)}this.protocol=aI[1].toLowerCase();this.username=aI[2];this.password=aI[3];this.hostname=aI[4];this.port=aI[5];this.pathname=aI[6]||"/";this.search=aI[7]||"";this.hash=aI[8]||"";if(!this.port){this.port=W.DEFAULT_PORTS[this.protocol]}if(this.port&&W.DEFAULT_PORTS[this.protocol]!==this.port){this.host=this.hostname+":"+this.port}else{this.host=this.hostname}};W.prototype={toString:function(){return this.protocol+"//"+(this.username||this.password?(this.username||"anonymous")+(this.password?":"+this.password:"")+"@":"")+this.hostname+(this.port&&R4.URL.DEFAULT_PORTS[this.protocol]!==this.port?":"+this.port:"")+this.pathname+this.search+this.hash}};V(W,{FILE_REGEX:/^(file:)\/\/()()()()([^#\?]*)(\?[^#]*)?(#.*)?$/i,NET_REGEX:/^([a-z][-_a-z0-9]*:)\/\/(?:([^:@\/]*)(?::([^:@\/]*))?@)?([^:@\/]*)(?::(\d+))?(?:(\/[^#\?]*)(\?[^#]*)?(#.*)?)?$/i,DEFAULT_PORTS:{"http:":"80","https:":"443","ftp:":"21","ftps:":"990","file:":""},abs:function(aI,aK){if(!aK){aK=window.location}if(aI.slice(0,2)==="//"){return aK.protocol+aI}else{if(aI[0]==="/"){return aK.protocol+"//"+aK.host+aI}else{if(aI[0]==="#"){return aK.protocol+"//"+aK.host+aK.pathname+aK.search+aI}else{if(aI[0]==="?"){return aK.protocol+"//"+aK.host+aK.pathname+aI}else{if((/^[a-z][-_a-z0-9]*:/i).test(aI)){return aI}else{var aJ=aK.pathname.split("/");aJ.pop();if(aJ.length===0){aJ.push("")}aJ.push(aI);return aK.protocol+"//"+aK.host+aJ.join("/")}}}}}},join:function(aK){for(var aJ=0;aJ<arguments.length;++aJ){var aI=arguments[aJ];if((/^[a-z][-_a-z0-9]*:/i).test(aI)){aK=aI}else{aK=new W(aK);if(aI.slice(0,2)==="//"){aK=aK.protocol+aI}else{if(aI[0]==="/"){aK=aK.protocol+"//"+aK.host+aI}else{if(aI[0]==="#"){aK=aK.protocol+"//"+aK.host+aK.pathname+aK.search+aI}else{if(aI[0]==="?"){aK=aK.protocol+"//"+aK.host+aK.pathname+aI}else{aK=aK.protocol+"//"+aK.host+aK.pathname+aI}}}}}}return aK}});var av=Object.prototype.toString.call(window.opera)==="[object Opera]";var aj=!!window.attachEvent&&!av;var t=navigator.userAgent.indexOf("Gecko")>-1&&navigator.userAgent.indexOf("KHTML")===-1;var w=typeof(Audio)!=="undefined";var s=function(aK,aQ){if(!aQ){return}if(typeof(aQ)==="string"){aK.appendChild(document.createTextNode(aQ))}else{if(Array.isArray(aQ)){for(var aL=0,aJ=aQ.length;aL<aJ;++aL){s(aK,aQ[aL])}}else{if(aQ.nodeType===1||aQ.nodeType===3){aK.appendChild(aQ)}else{for(var aO in aQ){var aP=aQ[aO];if(aO==="class"||aO==="className"){aK.className=String(aP)}else{if(aO==="for"||aO==="htmlFor"){aK.htmlFor=String(aP)}else{if(/^on/.test(aO)){if(typeof(aP)!=="function"){aP=new Function("event","if ((function (event) {\n"+aP+"\n}).call(this,event) === false) { event.preventDefault(); }")}n(aK,aO.replace(/^on/,""),aP)}else{if(aO==="style"){if(typeof(aP)==="object"){for(var aI in aP){var aM=aP[aI];if(aI==="float"){aK.style.cssFloat=aM;aK.style.styleFloat=aM}else{if(aI==="opacity"){z(aK,parseFloat(aM))}else{try{aK.style[aI]=aM}catch(aN){console.error(aI+"="+aM+" "+aN.toString())}}}}}else{aK.style.cssText+=";"+aP}}else{if(aO==="value"&&aK.nodeName==="TEXTAREA"){aK.value=aP}else{if(aP===true){aK.setAttribute(aO,aO)}else{if(aP===false){aK.removeAttribute(aO)}else{aK.setAttribute(aO,String(aP))}}}}}}}}}}}};var z=aj?function(aJ,aI){aJ.style.filter=aJ.style.filter.replace(/\balpha\([^\)]*\)/gi,"")+"alpha(opacity="+(parseFloat(aI)*100)+")";aJ.style.opacity=aI}:function(aJ,aI){aJ.style.opacity=aI};var b=function(aI){var aK=document.createElement(aI);for(var aJ=1,aL=arguments.length;aJ<aL;++aJ){s(aK,arguments[aJ])}return aK};var G=function(aJ,aI){return Object.prototype.hasOwnProperty.call(aJ,aI)};var ad=function(aK,aJ){for(var aI=0;aI<aK.length;){if(aK[aI]===aJ){aK.splice(aI,1)}else{++aI}}};var y=function(aJ,aI){return"data:"+aJ+";base64,"+ax.encode(aI)};var aH=function(aI){return aI.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")};var ax={encode:function(aI){return btoa(unescape(encodeURIComponent(aI)))},decode:function(aI){return decodeURIComponent(escape(atob(aI)))}};var m={parse:function(aN){var aJ=aN.split(/\r?\n/);var aL=[];for(var aK=0,aO=aJ.length;aK<aO;++aK){var aI=aJ[aK].trim();if(aI.length===0||aI.charAt(0)==="'"){continue}var aM=[];aI=this.parseLine(aI,aM);if(aI.length!==0){console.error("trailing text:",aI)}aL.push(aM)}return aL},parseLine:function(aI,aK){var aM;while((aI=aI.trimLeft()).length>0){var aJ=aI.charAt(0);switch(aJ){case'"':aI=aI.slice(1);aM=aI.search('"');if(aM<0){aM=aI.length}aK.push(aI.slice(0,aM));aI=aI.slice(aM);if(aI.length>0){aJ=aI.charAt(0);if(aJ==='"'){aI=aI.slice(1).trimLeft();aJ=aI.charAt(0)}if(aI.length>0){if(aJ===","){aI=aI.slice(1)}else{if(aJ!=="}"){console.error("data after quoted string:",aI)}}}}else{console.error("unterminated quoted string")}break;case",":aI=aI.slice(1);aK.push("");break;case"{":var aL=[];aK.push(aL);aI=this.parseLine(aI.slice(1),aL).trimLeft();if(aI.length>0){aJ=aI.charAt(0);if(aJ!=="}"){console.error("data after list:",aI)}else{aI=aI.slice(1).trimLeft();aJ=aI.charAt(0)}if(aJ===","){aI=aI.slice(1)}}else{console.error("unterminated list")}break;case"}":case"\n":return aI;default:aM=aI.search(/[,}]/);if(aM<0){aM=aI.length}aK.push(aI.slice(0,aM).trim());aI=aI.slice(aM);if(aI.length>0){aJ=aI.charAt(0);if(aJ===","){aI=aI.slice(1)}else{if(aJ!=="}"){console.error("syntax error:",aI)}}}}}return aI}};var D=function(aJ){var aI=aJ.trim().toLowerCase();if(aI==="true"){return true}else{if(aI==="false"){return false}else{throw new Error("illegal boolean value: "+aJ)}}};var u=function(aI){if(typeof(aI)==="string"){aI=aI.split(",")}if(aI.length!==2||!/^\s*-?\d+\s*$/.test(aI[0])||!/^\s*-?\d+\s*$/.test(aI[1])){throw new Error("illegal point value: "+aI.join(","))}return{x:parseInt(aI[0],10),y:parseInt(aI[1],10)}};var am=function(aI){if(typeof(aI)==="string"){return document.getElementById(aI)}else{if(aI&&aI.nodeType===1){return aI}else{return null}}};var L=function(aL,aK){var aJ=aK.x-aL.x;var aI=aK.y-aL.y;return Math.sqrt(aJ*aJ+aI*aI)};var ay=function(aI){return aI[Math.round((aI.length-1)*Math.random())]};var al={Left:0,Right:1,Up:2,Down:3,UpLeft:4,UpRight:5,DownLeft:6,DownRight:7};var T=function(aJ){for(var aI in al){if(al[aI]===aJ){return aI}}return"Not a Movement"};var p={None:0,HorizontalOnly:1,VerticalOnly:2,HorizontalVertical:3,DiagonalOnly:4,DiagonalHorizontal:5,DiagonalVertical:6,All:7,MouseOver:8,Sleep:9,Dragged:10};var ap={Top:0,Bottom:1,Left:2,Right:3,BottomRight:4,BottomLeft:5,TopRight:6,TopLeft:7,Center:8,Any:9,AnyNotCenter:10};var q={wav:"audio/wav",webm:"audio/webm",mpeg:"audio/mpeg",mpga:"audio/mpeg",mpg:"audio/mpeg",mp1:'audio/mpeg;codecs="mp1"',mp2:'audio/mpeg;codecs="mp2"',mp3:'audio/mpeg;codecs="mp3"',mp4:"audio/mp4",mp4a:"audio/mp4",ogg:"audio/ogg",oga:"audio/ogg",flac:'audio/ogg;codecs="flac"',spx:'audio/ogg;codecs="speex"'};var A=function(aJ){for(var aI in ap){if(ap[aI]===aJ){return aI}}return"Not a Location"};var ak=function ak(aJ){this.name=aJ.name;this.probability=aJ.probability;this.proximity=aJ.proximity==="default"?640:aJ.proximity;this.all=!!aJ.all;this.delay=aJ.delay;this.targets=[];this.behaviors=[];for(var aM=0,aO=aJ.behaviors.length;aM<aO;++aM){this.behaviors.push(aJ.behaviors[aM].toLowerCase())}for(var aM=0,aO=aJ.targets.length;aM<aO;++aM){var aL=aJ.targets[aM].toLowerCase();if(!G(l,aL)){console.warn("Interaction "+this.name+" of pony "+aJ.pony+" references non-existing pony "+aL)}else{var aI=l[aL];for(var aK=0;aK<this.behaviors.length;){var aN=this.behaviors[aK];if(G(aI.behaviors_by_name,aN)){++aK}else{this.behaviors.splice(aK,1)}}this.targets.push(aI)}}};ak.prototype={reachableTargets:function(aQ){var aP=[];for(var aN=0,aJ=this.targets.length;aN<aJ;++aN){var aM=this.targets[aN];var aI=false;for(var aL=0,aK=aM.instances.length;aL<aK;++aL){var aO=aM.instances[aL];if(L(aQ,aO.position())<this.proximity){aP.push(aO);aI=true}}if(this.all&&!aI){return[]}}return aP}};var aC=function aC(aO,aM){V(this,aM);if(!this.name||this.name.toLowerCase()==="none"){throw new Error(aO+": illegal behavior name "+this.name)}if(this.follow){this.follow=this.follow.toLowerCase()}this.movement=null;var aI=aM.movement.replace(/[-_\s]/g,"").toLowerCase();for(var aJ in p){if(aJ.toLowerCase()===aI){this.movement=p[aJ];break}}if(this.movement===null){throw new Error(aO+": illegal movement "+aM.movement+" for behavior "+aM.name)}this.rightsize={width:0,height:0};if(aM.rightimage){this.rightimage=W.join(aO,aM.rightimage)}this.leftsize={width:0,height:0};if(aM.leftimage){this.leftimage=W.join(aO,aM.leftimage)}if(!this.rightcenter||(this.rightcenter.x===0&&this.rightcenter.y===0)){this.rightcenter={x:0,y:0,missing:true}}if(!this.leftcenter||(this.leftcenter.x===0&&this.leftcenter.y===0)){this.leftcenter={x:0,y:0,missing:true}}this.effects=[];this.effects_by_name={};if("effects" in aM){for(var aK=0,aN=aM.effects.length;aK<aN;++aK){var aL=new J(aO,aM.effects[aK]);this.effects_by_name[aL.name.toLowerCase()]=aL;this.effects.push(aL)}}};aC.prototype={deref:function(aK,aI){var aJ=this[aK];var aL=(aJ||"").toLowerCase();if(aJ&&aL!=="none"){if(G(aI.behaviors_by_name,aL)){this[aK]=aI.behaviors_by_name[aL]}else{console.warn(r("%s: Behavior %s of pony %s references non-existing behavior %s.",aI.baseurl,this.name,aI.name,aJ));delete this[aK]}}else{delete this[aK]}},preload:function(){for(var aI=0,aJ=this.effects.length;aI<aJ;++aI){this.effects[aI].preload()}if(this.rightimage){ag(this.rightimage,function(aK){this.rightsize.width=aK.width;this.rightsize.height=aK.height;if(this.rightcenter.missing){this.rightcenter={x:Math.round(aK.width*0.5),y:Math.round(aK.height*0.5)}}}.bind(this))}if(this.leftimage){ag(this.leftimage,function(aK){this.leftsize.width=aK.width;this.leftsize.height=aK.height;if(this.leftcenter.missing){this.leftcenter={x:Math.round(aK.width*0.5),y:Math.round(aK.height*0.5)}}}.bind(this))}},isMoving:function(){if(this.follow||this.x||this.x){return true}switch(this.movement){case p.None:case p.MouseOver:case p.Sleep:return false;default:return true}}};var ab=function(aJ){var aK=aJ.replace(/[-_\s]/g,"").toLowerCase();for(var aI in ap){if(aI.toLowerCase()===aK){return ap[aI]}}throw new Error("illegal location: "+aJ)};var J=function J(aM,aK){V(this,aK);this.name=aK.name.toLowerCase();var aL=["rightloc","leftloc","rightcenter","leftcenter"];for(var aJ=0;aJ<aL.length;++aJ){var aI=aL[aJ];if(aI in aK){this[aI]=ab(aK[aI])}}this.rightsize={width:0,height:0};if(aK.rightimage){this.rightimage=W.join(aM,aK.rightimage)}this.rightcenter_point={x:0,y:0};this.leftsize={width:0,height:0};if(aK.leftimage){this.leftimage=W.join(aM,aK.leftimage)}this.leftcenter_point={x:0,y:0}};J.prototype={preload:function(){if(this.rightimage){ag(this.rightimage,function(aI){this.rightsize.width=aI.width;this.rightsize.height=aI.height;this.rightcenter_point={x:Math.round(aI.width*0.5),y:Math.round(aI.height*0.5)}}.bind(this))}if(this.leftimage){ag(this.leftimage,function(aI){this.leftsize.width=aI.width;this.leftsize.height=aI.height;this.leftcenter_point={x:Math.round(aI.width*0.5),y:Math.round(aI.height*0.5)}}.bind(this))}}};var Q=function(aK,aI){var aL=Math.min(aK.length,aI.length);for(var aJ=0;aJ<aL;++aJ){if(aK.charAt(aJ)!==aI.charAt(aJ)){return aJ}}return aL};var k={};var C=0;var U=0;var Y=[];var aA=[];var R=function(aI,aK,aJ){var aL=aI.object=new Image();n(aL,"load",d(aJ,true));n(aL,"error",d(aJ,false));n(aL,"abort",d(aJ,false));aL.src=aK};var i=function(aL){var aJ=new Audio();if(typeof(aL)==="string"){aJ.src=aL}else{for(var aI in aL){var aK=b("source",{src:aL[aI]});if(aI!=="audio/x-unknown"){aK.type=aI}aJ.appendChild(aK)}}return aJ};var ai=function(aI){return function(aJ,aM,aK){var aL=aJ.object=i(aI);n(aL,"loadeddata",d(aK,true));n(aL,"error",d(aK,false));n(aL,"abort",d(aK,false));aL.preload="auto"}};var ag=function(aI,aJ){aw(R,aI,aJ)};var aG=function(aN,aP){var aM;if(typeof(aN)==="string"){aM=aN}else{var aL=[];for(var aK in aN){aL.push(aN[aK])}if(aL.length===0){throw new Error("no audio url to preload")}else{if(aL.length===1){aM=aL[0]}else{var aJ=aL[0];for(var aI=1;aI<aL.length;++aI){var aO=Q(aJ,aL[aI]);if(aO!==aJ.length){aJ=aJ.slice(0,aO)}}for(var aI=0;aI<aL.length;++aI){aL[aI]=aL[aI].slice(aJ.length)}aL.sort();aM=aJ+"{"+aL.join("|")+"}"}}}aw(ai(aN),aM,aP)};var aw=function(aK,aJ,aL){if(G(k,aJ)){if(aL){var aI=k[aJ];if(aI.loaded){aL(aI.object)}else{aI.callbacks.push(aL)}}}else{++C;var aI=k[aJ]={loaded:false,callbacks:aL?[aL]:[]};aK(aI,aJ,function(aN){if(aI.loaded){console.error("resource loaded twice: "+aJ);return}aI.loaded=true;++U;if(aN){console.log(r("%3.0f%% %d of %d loaded: %s",U*100/C,U,C,aJ))}else{console.error(r("%3.0f%% %d of %d load error: %s",U*100/C,U,C,aJ))}for(var aM=0,aO=aA.length;aM<aO;++aM){aA[aM](U,C,aJ,aN)}for(var aM=0,aO=aI.callbacks.length;aM<aO;++aM){aI.callbacks[aM](aI.object,aN)}delete aI.callbacks;if(U===C){for(var aM=0,aO=Y.length;aM<aO;++aM){Y[aM]()}Y=[]}})}};aw(function(aI,aL,aJ){if(document.body){aJ(true)}else{var aK=false;var aM=function(){if(!aK){aK=true;aJ(true)}};if(document.addEventListener){n(document,"DOMContentLoaded",aM)}else{var aN=function(){if(document.readyState==="complete"){v(document,"readystatechange",aN);aM()}};n(document,"readystatechange",aN)}n(window,"load",aM)}},document.location.href);var Z=function(aI){if(U===C){aI()}else{Y.push(aI)}};var aa=function(aI){aA.push(aI)};var I=0;var aD=null;var E=function(){I=U;document.body.appendChild(aD.container);af();setTimeout(function(){if(aD&&!aD.finished){aD.container.style.display=""}},250);n(window,"resize",af);v(window,"load",E)};var af=function(){var aL=e();var aJ=false;if(aD.container.style.display==="none"){aJ=true;aD.container.style.visibility="hidden";aD.container.style.display=""}var aK=aD.container.offsetWidth;var aI=aD.container.offsetHeight;var aM=aD.label.offsetHeight;if(aJ){aD.container.style.display="none";aD.container.style.visibility=""}aD.container.style.left=Math.round((aL.width-aK)*0.5)+"px";aD.container.style.top=Math.round((aL.height-aI)*0.5)+"px";aD.label.style.top=Math.round((aI-aM)*0.5)+"px"};aa(function(aL,aN,aK){if(o||aD){if(!aD){aD={bar:b("div",{style:{margin:"0",padding:"0",borderStyle:"none",width:"0",height:"100%",background:"#9BD6F4",MozBorderRadius:"5px",borderRadius:"5px"}}),label:b("div",{style:{position:"absolute",margin:"0",padding:"0",borderStyle:"none",top:"0px",left:"0px",width:"100%",textAlign:"center"}})};aD.barcontainer=b("div",{style:{margin:"0",padding:"0",borderStyle:"none",width:"100%",height:"100%",background:"#D8D8D8",MozBorderRadius:"5px",borderRadius:"5px"}},aD.bar);aD.container=b("div",{style:{position:"fixed",width:"450px",height:"30px",background:"white",padding:"10px",margin:"0",MozBorderRadius:"5px",borderRadius:"5px",color:"#294256",fontWeight:"bold",fontSize:"16px",opacity:"0.9",display:"none",boxShadow:"2px 2px 12px rgba(0,0,0,0.4)",MozBoxShadow:"2px 2px 12px rgba(0,0,0,0.4)"},onclick:function(){if(aD){aD.container.style.display="none"}}},aD.barcontainer,aD.label)}if(aD.container.style.display==="none"){I=aL}aD.finished=aL===aN;var aJ=aL-I;var aM=aN-I;var aI=aM===0?1:aJ/aM;aD.bar.style.width=Math.round(aI*450)+"px";aD.label.innerHTML=r("Loading Ponies&hellip; %d%%",Math.floor(aI*100));if(!aD.container.parentNode){if(document.body){E()}else{n(window,"load",E)}}if(aD.finished){setTimeout(function(){if(aD&&aD.container.parentNode){aD.container.parentNode.removeChild(aD.container)}aD=null;v(window,"resize",af);v(window,"load",E)},500)}}});var h=function h(aO){this.baseurl=W.join(P,aO.baseurl);if(!aO.name){throw new Error("pony with following base URL has no name: "+this.baseurl)}this.name=aO.name;this.all_behaviors=[];this.random_behaviors=[];this.mouseover_behaviors=[];this.dragged_behaviors=[];this.stand_behaviors=[];this.behaviors_by_name={};this.speeches=[];this.random_speeches=[];this.speeches_by_name={};this.interactions=[];this.instances=[];this.categories=[];if(aO.categories){for(var aQ=0,aM=aO.categories.length;aQ<aM;++aQ){this.categories.push(aO.categories[aQ].toLowerCase())}}if(aO.speeches){for(var aQ=0,aM=aO.speeches.length;aQ<aM;++aQ){var aL=V({},aO.speeches[aQ]);if(aL.files){var aR=0;for(var aS in aL.files){aL.files[aS]=W.join(this.baseurl,aL.files[aS]);++aR}if(aR===0){delete aL.files}}if(aL.name){var aP=aL.name.toLowerCase();if(G(this.speeches_by_name,aP)){console.warn(r("%s: Speech name %s of pony %s is not unique.",this.baseurl,aL.name,aO.name))}else{this.speeches_by_name[aP]=aL}}if(!aL.skip){this.random_speeches.push(aL)}this.speeches.push(aL)}}var aK=["speakstart","speakend"];if("behaviors" in aO){for(var aQ=0,aM=aO.behaviors.length;aQ<aM;++aQ){var aJ=new aC(this.baseurl,aO.behaviors[aQ]);var aP=aJ.name.toLowerCase();if(G(this.behaviors_by_name,aP)){console.warn(r("%s: Behavior name %s of pony %s is not unique.",this.baseurl,aJ.name,aO.name))}else{this.behaviors_by_name[aP]=aJ}for(var aN=0;aN<aK.length;++aN){var aI=aK[aN];var aT=aJ[aI];if(aT){aT=aT.toLowerCase();if(G(this.speeches_by_name,aT)){aJ[aI]=this.speeches_by_name[aT]}else{console.warn(r("%s: Behavior %s of pony %s references non-existing speech %s.",this.baseurl,aJ.name,aO.name,aJ[aI]));delete aJ[aI]}}}this.all_behaviors.push(aJ);if(!aJ.skip){this.random_behaviors.push(aJ)}switch(aJ.movement){case p.MouseOver:this.mouseover_behaviors.push(aJ);if(!aJ.skip){this.stand_behaviors.push(aJ)}break;case p.Dragged:this.dragged_behaviors.push(aJ);if(!aJ.skip){this.stand_behaviors.push(aJ)}break;case p.None:if(!aJ.skip){this.stand_behaviors.push(aJ)}break}}if(this.dragged_behaviors.length===0&&this.mouseover_behaviors.length>0){this.dragged_behaviors=this.mouseover_behaviors.slice()}if(this.stand_behaviors.length===0){for(var aQ=0,aM=this.all_behaviors.length;aQ<aM;++aQ){var aJ=this.all_behaviors[aQ];if(aJ.movement===p.Sleep&&!aJ.skip){this.stand_behaviors.push(aJ)}}}if(this.stand_behaviors.length===0){console.warn(r("%s: Pony %s has no (non-skip) non-moving behavior.",this.baseurl,this.name))}else{if(this.mouseover_behaviors.length===0){this.mouseover_behaviors=this.stand_behaviors.slice()}}for(var aQ=0,aM=this.all_behaviors.length;aQ<aM;++aQ){var aJ=this.all_behaviors[aQ];aJ.deref("linked",this);aJ.deref("stopped",this);aJ.deref("moving",this)}}};h.prototype={preload:function(){for(var aJ=0,aK=this.all_behaviors.length;aJ<aK;++aJ){this.all_behaviors[aJ].preload()}if(w&&g){for(var aJ=0,aK=this.speeches.length;aJ<aK;++aJ){var aI=this.speeches[aJ];if(aI.files){aG(aI.files)}}}},unspawnAll:function(){while(this.instances.length>0){this.instances[0].unspawn()}},addInteraction:function(aI){aI=new ak(aI);if(aI.targets.length===0){console.warn("Dropping interaction "+aI.name+" of pony "+this.name+" because it has no targets.");return false}for(var aJ=0,aL=aI.behaviors.length;aJ<aL;){var aK=aI.behaviors[aJ];if(G(this.behaviors_by_name,aK)){++aJ}else{aI.behaviors.splice(aJ,1)}}if(aI.behaviors.length===0){console.warn("Dropping interaction "+aI.name+" of pony "+this.name+" because it has no common behaviors.");return false}this.interactions.push(aI);return true}};var ae=function(aK,aI){var aJ=aK.parentNode;while(aJ){if(aJ===aI){return true}}return false};var at=function(aI){return K(aI,e())};var K=function(aL,aK){var aI=aL.width*0.5;var aJ=aL.height*0.5;return aL.x<aI||aL.y<aJ||aL.x+aI>aK.width||aL.y+aJ>aK.height};var aB=function(aM){var aL=e();var aI=aM.x;var aN=aM.y;var aJ=aM.width*0.5;var aK=aM.height*0.5;if(aI<aJ){aI=aJ}else{if(aI+aJ>aL.width){aI=aL.width-aJ}}if(aN<aK){aN=aK}else{if(aN+aK>aL.height){aN=aL.height-aK}}return{x:Math.round(aI),y:Math.round(aN)}};var aF=function aF(){};aF.prototype={setTopLeftPosition:function(aJ){this.current_position.x=aJ.x+this.current_center.x;this.current_position.y=aJ.y+this.current_center.y;this.img.style.left=Math.round(aJ.x)+"px";this.img.style.top=Math.round(aJ.y)+"px";var aI=Math.round(a+aJ.y+this.current_size.height);if(this.zIndex!==aI){this.img.style.zIndex=aI}},setPosition:function(aM){var aI=this.current_position.x=aM.x;var aL=this.current_position.y=aM.y;var aJ=Math.round(aL-this.current_center.y);this.img.style.left=Math.round(aI-this.current_center.x)+"px";this.img.style.top=aJ+"px";var aK=Math.round(a+aJ+this.current_size.height);if(this.zIndex!==aK){this.img.style.zIndex=aK}},moveBy:function(aI){this.setPosition({x:this.current_position.x+aI.x,y:this.current_position.y+aI.y})},clipToScreen:function(){this.setPosition(aB(this.rect()))},topLeftPosition:function(){return{x:this.current_position.x-this.current_center.x,y:this.current_position.y-this.current_center.y}},position:function(){return this.current_position},size:function(){return this.current_size},rect:function(){var aI=this.current_position;aI.width=this.current_size.width;aI.height=this.current_size.height;return aI},topLeftRect:function(){var aJ=this.topLeftPosition();var aI=this.size();return{x:aJ.x,y:aJ.y,width:aI.width,height:aI.height}},isOffscreen:function(){return at(this.rect())}};var ao=function ao(aI){this.pony=aI;this.img=b("img",{draggable:"false",style:{position:"fixed",userSelect:"none",borderStyle:"none",margin:"0",padding:"0",backgroundColor:"transparent",zIndex:String(a)},ondblclick:function(){var aK=this.position();var aJ=(this.end_time-this.start_time)/1000;console.log(r("%s does %s%s for %.2f seconds, is at %d x %d and %s. See:",this.pony.name,this.current_behavior.name,this.current_behavior===this.paint_behavior?"":" using "+this.paint_behavior.name,aJ,aK.x,aK.y,(this.following?"follows "+this.following.name():r("wants to go to %d x %d",this.dest_position.x,this.dest_position.y))),this)}.bind(this),onmousedown:function(aJ){if(aj?aJ.button&1:aJ.button===0){x=this;this.mouseover=true;if(N!==null){this.nextBehavior(true)}aJ.preventDefault()}}.bind(this),onmouseover:function(){if(!this.mouseover){this.mouseover=true;if(!this.isMouseOverOrDragging()&&this.canMouseOverOrDrag()&&N!==null){this.nextBehavior(true)}}}.bind(this),onmouseout:function(aJ){var aK=aJ.target;if(this.mouseover){this.mouseover=false}}.bind(this)});this.clear()};ao.prototype=V(new aF(),{isMouseOverOrDragging:function(){return this.current_behavior&&(this.current_behavior.movement===p.MouseOver||this.current_behavior.movement===p.Dragged)},canMouseOverOrDrag:function(){return this.pony.mouseover_behaviors.length>0||this.pony.dragged_behaviors.length>0},name:function(){return this.pony.name},unspawn:function(){var aJ=Date.now();if(this.effects){for(var aI=0,aK=this.effects.length;aI<aK;++aI){ac.push({at:aJ,element:this.effects[aI].img})}}ac.push({at:aJ,element:this.img});ad(this.pony.instances,this);ad(S,this)},clear:function(){if(this.effects){for(var aI=0,aJ=this.effects.length;aI<aJ;++aI){this.effects[aI].clear()}}if(this.img.parentNode){this.img.parentNode.removeChild(this.img)}this.mouseover=false;this.start_time=null;this.end_time=null;this.current_interaction=null;this.interaction_targets=null;this.current_imgurl=null;this.interaction_wait=0;this.current_position={x:0,y:0};this.dest_position={x:0,y:0};this.current_size={width:0,height:0};this.current_center={x:0,y:0};this.zIndex=a;this.current_behavior=null;this.paint_behavior=null;this.facing_right=true;this.end_at_dest=false;this.effects=[];this.repeating=[]},interact:function(aN,aK,aJ){var aI,aM=ay(aK.behaviors);this.behave(this.pony.behaviors_by_name[aM]);if(aK.all){for(var aL=0,aO=aJ.length;aL<aO;++aL){aI=aJ[aL];aI.behave(aI.pony.behaviors_by_name[aM]);aI.current_interaction=aK}}else{aI=ay(aJ);aI.behave(aI.pony.behaviors_by_name[aM]);aI.current_interaction=aK}this.current_interaction=aK;this.interaction_targets=aJ},speak:function(aM,aJ){if(aJ.text){var aN=Math.max(aJ.text.length*150,1000);var aO=b("div",{style:{fontSize:"14px",color:"#294256",background:aj?"white":"rgba(255,255,255,0.8)",position:"fixed",visibility:"hidden",margin:"0",padding:"4px",maxWidth:"250px",textAlign:"center",borderRadius:"10px",MozBorderRadius:"10px",width:"auto",height:"auto",boxShadow:"2px 2px 12px rgba(0,0,0,0.4)",MozBoxShadow:"2px 2px 12px rgba(0,0,0,0.4)",zIndex:String(a+9000)}},aJ.text);var aL=this.topLeftRect();O().appendChild(aO);var aI=Math.round(aL.x+aL.width*0.5-aO.offsetWidth*0.5);var aP=aL.y+aL.height;aO.style.left=aI+"px";aO.style.top=aP+"px";aO.style.visibility="";ac.push({element:aO,at:aM+aN})}if(w&&g&&aJ.files){var aK=i(aJ.files);aK.volume=H;aK.play()}},update:function(a7,aZ,aL){var a8=this.rect();var aT=null;var a1;if(this.following){if(this.following.img.parentNode){aT=this.dest_position;aT.x=this.following.current_position.x;aT.y=this.following.current_position.y;aT.x+=this.following.facing_right?this.current_behavior.x:-this.current_behavior.x;aT.y+=this.current_behavior.y;a1=L(a8,aT);if(!this.current_behavior.x&&!this.current_behavior.y&&a1<=a8.width*0.5){aT=null}}else{this.following=null}}else{aT=this.dest_position;if(aT){a1=L(a8,aT)}}var aP;if(aT){var aV=aT.x-a8.x;var aU=aT.y-a8.y;var aO=this.current_behavior.speed*aZ*0.01*B;if(aO>=a1){aP=aT}else{var bb=aO/a1;aP={x:Math.round(a8.x+bb*aV),y:Math.round(a8.y+bb*aU)}}if(aP.x!==aT.x){this.setFacingRight(aP.x<=aT.x)}else{if(this.following){if(this.current_behavior.auto_select_images){}else{if(Math.round(aO)===0){if(this.current_behavior.stopped){this.paint_behavior=this.current_behavior.stopped}}else{if(this.current_behavior.moving){this.paint_behavior=this.current_behavior.moving}}}this.setFacingRight(this.following.facing_right)}}this.setPosition(aP)}else{aP=a8}for(var a3=0;a3<this.effects.length;){var aY=this.effects[a3];if(aY.update(a7,aZ,aL)){++a3}else{this.effects.splice(a3,1);ac.push({element:aY.img,at:a7})}}for(var a3=0,a2=this.repeating.length;a3<a2;++a3){var a6=this.repeating[a3];if(a6.at<=a7){var aM=new az(this,a7,a6.effect);ah.appendChild(aM.img);aM.updatePosition(a7,0);this.effects.push(aM);a6.at+=a6.effect.delay*1000}}if(this.interaction_wait<=a7&&this.pony.interactions.length>0&&!this.current_interaction){var a0=0;var aI=[];var aQ=null;for(var a3=0,a2=this.pony.interactions.length;a3<a2;++a3){aQ=this.pony.interactions[a3];var ba=aQ.reachableTargets(a8);if(ba.length>0){a0+=aQ.probability;aI.push([aQ,ba])}}if(aI.length>0){var aW=Math.random()*a0;var aS=0;for(var a3=0,a2=aI.length;a3<a2;++a3){aQ=aI[a3];aS+=aQ.probability;if(aW<=aS){break}}aW=Math.random()*(100/X);if(aW<=aQ[0].probability){this.interact(a7,aQ[0],aQ[1]);return}}this.interaction_wait+=X}if(a7>=this.end_time||(this.end_at_dest&&this.dest_position.x===aP.x&&this.dest_position.y===aP.y)){this.nextBehavior();return}if(this.following){return}var a5=this.current_center.x;var aK=this.current_center.y;var a4=this.current_size.width-a5;var aJ=this.current_size.height-aK;var aN=aP.x-a5;var a9=aP.x+a4;var aX=aP.y-aK;var aR=aP.y+aJ;if(aN<=0){if(this.dest_position.x<aP.x){this.dest_position.x=Math.round(Math.max(aP.x+aP.x-this.dest_position.x,a5))}}else{if(a9>=aL.width){if(this.dest_position.x>aP.x){this.dest_position.x=Math.round(Math.min(aP.x+aP.x-this.dest_position.x,aL.width-a4))}}}if(aX<=0){if(this.dest_position.y<aP.y){this.dest_position.y=Math.round(Math.max(aP.y+aP.y-this.dest_position.y,aK))}}else{if(aR>=aL.height){if(this.dest_position.y>aP.y){this.dest_position.y=Math.round(Math.min(aP.y+aP.y-this.dest_position.y,aL.height-aJ))}}}},getNearestInstance:function(aI){var aP=[];var aQ=this.position();var aM=l[aI];if(!aM){for(var aN=0,aJ=S.length;aN<aJ;++aN){var aO=S[aN];if(!this.loops(aO)){for(var aL=0,aK=aO.effects.length;aL<aK;++aL){var aR=aO.effects[aL];if(aR.effect.name===aI){aP.push([L(aQ,aR.position()),aR])}}}}}else{for(var aN=0,aJ=aM.instances.length;aN<aJ;++aN){var aO=aM.instances[aN];if(!this.loops(aO)){aP.push([L(aQ,aO.position()),aO])}}}if(aP.length===0){return null}aP.sort(function(aS,aT){return aS[0]-aT[0]});return aP[0][1]},nextBehavior:function(aJ){var aI=this.isOffscreen();if(!aJ&&this.current_behavior&&this.current_behavior.linked){this.behave(this.current_behavior.linked,aI)}else{if(this.current_interaction){var aL=Date.now();this.interaction_wait=aL+this.current_interaction.delay*1000;if(this.interaction_targets){for(var aK=0,aM=this.interaction_targets.length;aK<aM;++aK){this.interaction_targets[aK].interaction_wait=this.interaction_wait}this.interaction_targets=null}this.current_interaction=null}this.behave(this.randomBehavior(aI),aI)}},setFacingRight:function(aJ){this.facing_right=aJ;var aI;if(aJ){aI=this.paint_behavior.rightimage;this.current_size=this.paint_behavior.rightsize;this.current_center=this.paint_behavior.rightcenter}else{aI=this.paint_behavior.leftimage;this.current_size=this.paint_behavior.leftsize;this.current_center=this.paint_behavior.leftcenter}if(aI!==this.current_imgurl){this.img.src=this.current_imgurl=aI}},behave:function(aS,aX){this.start_time=Date.now();var aI=(aS.minduration+(aS.maxduration-aS.minduration)*Math.random());this.end_time=this.start_time+aI*1000;var aP=this.current_behavior;this.current_behavior=this.paint_behavior=aS;var aL=[];for(var a0=0,aY=this.effects.length;a0<aY;++a0){var aK=this.effects[a0];if(aK.effect.duration){aL.push(aK)}else{ac.push({element:aK.img,at:this.start_time})}}if(this.facing_right){this.current_size=this.paint_behavior.rightsize;this.current_center=this.paint_behavior.rightcenter}else{this.current_size=this.paint_behavior.leftsize;this.current_center=this.paint_behavior.leftcenter}var aO=false;if(aP&&aP.speakend){this.speak(this.start_time,aP.speakend);aO=true}this.following=null;if(aS.follow){this.following=this.getNearestInstance(aS.follow)}if(aS.speakstart){this.speak(this.start_time,aS.speakstart)}else{if(!aO&&!this.following&&!this.current_interaction&&this.pony.random_speeches.length>0&&Math.random()<au){this.speak(this.start_time,ay(this.pony.random_speeches))}}var aN=this.position();var aV=this.size();var aJ=e();this.end_at_dest=false;if(this.following){this.dest_position.x=this.following.current_position.x;this.dest_position.y=this.following.current_position.y}else{if(!aS.follow&&(aS.x||aS.y)){this.end_at_dest=true;this.dest_position={x:Math.round((aJ.width-aV.width)*(aS.x||0)/100),y:Math.round((aJ.height-aV.height)*(aS.y||0)/100)}}else{var aM=null;switch(aS.movement){case p.HorizontalOnly:aM=[al.Left,al.Right];break;case p.VerticalOnly:aM=[al.Up,al.Down];break;case p.HorizontalVertical:aM=[al.Left,al.Right,al.Up,al.Down];break;case p.DiagonalOnly:aM=[al.UpLeft,al.UpRight,al.DownLeft,al.DownRight];break;case p.DiagonalHorizontal:aM=[al.Left,al.Right,al.UpLeft,al.UpRight,al.DownLeft,al.DownRight];break;case p.DiagonalVertical:aM=[al.Up,al.Down,al.UpLeft,al.UpRight,al.DownLeft,al.DownRight];break;case p.All:aM=[al.Left,al.Right,al.Up,al.Down,al.UpLeft,al.UpRight,al.DownLeft,al.DownRight];break}if(aM===null){this.dest_position.x=Math.round(aN.x);this.dest_position.y=Math.round(aN.y)}else{var aQ=aN.y-aV.height*0.5<100;var a3=aN.y+aV.height*0.5+100>aJ.height;var aR=aN.x-aV.width*0.5<100;var aZ=aN.x+aV.width*0.5+100>aJ.width;var aU=aM.slice();if(aQ){ad(aU,al.Up);ad(aU,al.UpLeft);ad(aU,al.UpRight)}if(a3){ad(aU,al.Down);ad(aU,al.DownLeft);ad(aU,al.DownRight)}if(aR){ad(aU,al.Left);ad(aU,al.UpLeft);ad(aU,al.DownLeft)}if(aZ){ad(aU,al.Right);ad(aU,al.UpRight);ad(aU,al.DownRight)}var aW=aS.speed*aI*100*B;var a2;switch(ay(aU.length===0?aM:aU)){case al.Up:this.dest_position={x:aN.x,y:aN.y-aW};break;case al.Down:this.dest_position={x:aN.x,y:aN.y+aW};break;case al.Left:this.dest_position={x:aN.x-aW,y:aN.y};break;case al.Right:this.dest_position={x:aN.x+aW,y:aN.y};break;case al.UpLeft:a2=Math.sqrt(aW*aW*0.5);this.dest_position={x:aN.x-a2,y:aN.y-a2};break;case al.UpRight:a2=Math.sqrt(aW*aW*0.5);this.dest_position={x:aN.x+a2,y:aN.y-a2};break;case al.DownLeft:a2=Math.sqrt(aW*aW*0.5);this.dest_position={x:aN.x-a2,y:aN.y+a2};break;case al.DownRight:a2=Math.sqrt(aW*aW*0.5);this.dest_position={x:aN.x+a2,y:aN.y+a2};break}if(aX){this.dest_position=aB(V(this.dest_position,aV));this.end_at_dest=true}else{this.dest_position.x=Math.round(this.dest_position.x);this.dest_position.y=Math.round(this.dest_position.y)}}}}this.setFacingRight(aN.x!==this.dest_position.x?aN.x<=this.dest_position.x:this.facing_right);this.setPosition(this.current_position);var a1=O();this.repeating=[];for(var a0=0,aY=aS.effects.length;a0<aY;++a0){var aT=aS.effects[a0];var aK=new az(this,this.start_time,aT);a1.appendChild(aK.img);aK.updatePosition(this.start_time,0);aL.push(aK);if(aT.delay){this.repeating.push({effect:aT,at:this.start_time+aT.delay*1000})}}this.effects=aL},teleport:function(){var aJ=e();var aI=this.size();this.setTopLeftPosition({x:Math.random()*(aJ.width-aI.width),y:Math.random()*(aJ.height-aI.height)})},randomBehavior:function(aI){var aK;if(this===x&&this.pony.dragged_behaviors.length>0){aK=this.pony.dragged_behaviors}else{if(this.mouseover&&this.pony.mouseover_behaviors.length>0){aK=this.pony.mouseover_behaviors}else{aK=this.pony.random_behaviors}}var aO=0;var aP=[];for(var aN=0,aM=aK.length;aN<aM;++aN){var aJ=aK[aN];if(aI&&!aJ.isMoving()){continue}aO+=aJ.probability;aP.push(aJ)}var aQ=Math.random()*aO;var aL=0;for(var aN=0,aM=aP.length;aN<aM;++aN){var aJ=aP[aN];aL+=aJ.probability;if(aQ<=aL){return aJ}}return aI?this.randomBehavior(false):null},loops:function(aI){while(aI){if(this===aI){return true}aI=aI.following}return false}});var az=function az(aL,aO,aR){this.pony=aL;this.start_time=aO;var aK=aR.duration*1000;if(t){aK*=0.6}aK=Math.max(aK-M,M);this.end_time=aO+aK;this.effect=aR;var aQ;if(aL.facing_right){aQ=this.effect.rightimage;this.current_size=this.effect.rightsize;this.current_center=this.effect.rightcenter_point}else{aQ=this.effect.leftimage;this.current_size=this.effect.leftsize;this.current_center=this.effect.leftcenter_point}this.current_position={x:0,y:0};this.zIndex=a;this.current_imgurl=null;this.img=b(t||av?"img":"iframe",{draggable:"false",style:{position:"fixed",overflow:"hidden",userSelect:"none",pointerEvents:"none",borderStyle:"none",margin:"0",padding:"0",backgroundColor:"transparent",zIndex:String(a)}});if(aj){this.img.setAttribute("scrolling","no");this.img.setAttribute("frameborder","0");this.img.setAttribute("marginheight","0");this.img.setAttribute("marginwidth","0")}this.setImage(aQ);var aN=["rightloc","rightcenter","leftloc","leftcenter"];for(var aM=0,aJ=aN.length;aM<aJ;++aM){var aI=aN[aM];var aP=aR[aI];if(aP===ap.Any){aP=ay([ap.Top,ap.Bottom,ap.Left,ap.Right,ap.BottomRight,ap.BottomLeft,ap.TopRight,ap.TopLeft,ap.Center])}else{if(aP===ap.AnyNotCenter){aP=ay([ap.Top,ap.Bottom,ap.Left,ap.Right,ap.BottomRight,ap.BottomLeft,ap.TopRight,ap.TopLeft])}}this[aI]=aP}};az.prototype=V(new aF(),{name:function(){return this.effect.name},clear:function(){if(this.img.parentNode){this.img.parentNode.removeChild(this.img)}},updatePosition:function(aL,aO){var aM,aI;if(this.pony.facing_right){aM=this.rightloc;aI=this.rightcenter}else{aM=this.leftloc;aI=this.leftcenter}var aK=this.size();var aN;switch(aI){case ap.Top:aN={x:-aK.width*0.5,y:0};break;case ap.Bottom:aN={x:-aK.width*0.5,y:-aK.height};break;case ap.Left:aN={x:0,y:-aK.height*0.5};break;case ap.Right:aN={x:-aK.width,y:-aK.height*0.5};break;case ap.BottomRight:aN={x:-aK.width,y:-aK.height};break;case ap.BottomLeft:aN={x:0,y:-aK.height};break;case ap.TopRight:aN={x:-aK.width,y:0};break;case ap.TopLeft:aN={x:0,y:0};break;case ap.Center:aN={x:-aK.width*0.5,y:-aK.height*0.5};break}var aJ=this.pony.topLeftRect();switch(aM){case ap.Top:aN.x+=aJ.x+aJ.width*0.5;aN.y+=aJ.y;break;case ap.Bottom:aN.x+=aJ.x+aJ.width*0.5;aN.y+=aJ.y+aJ.height;break;case ap.Left:aN.x+=aJ.x;aN.y+=aJ.y+aJ.height*0.5;break;case ap.Right:aN.x+=aJ.x+aJ.width;aN.y+=aJ.y+aJ.height*0.5;break;case ap.BottomRight:aN.x+=aJ.x+aJ.width;aN.y+=aJ.y+aJ.height;break;case ap.BottomLeft:aN.x+=aJ.x;aN.y+=aJ.y+aJ.height;break;case ap.TopRight:aN.x+=aJ.x+aJ.width;aN.y+=aJ.y;break;case ap.TopLeft:aN.x+=aJ.x;aN.y+=aJ.y;break;case ap.Center:aN.x+=aJ.x+aJ.width*0.5;aN.y+=aJ.y+aJ.height*0.5;break}this.setTopLeftPosition(aN)},setImage:function(aI){if(this.current_imgurl!==aI){this.img.src=this.current_imgurl=aI;this.img.style.width=this.current_size.width+"px";this.img.style.height=this.current_size.height+"px"}},update:function(aK,aL,aJ){if(this.effect.follow){this.updatePosition(aK,aL);var aI;if(this.pony.facing_right){aI=this.effect.rightimage;this.current_size=this.effect.rightsize;this.current_center=this.effect.rightcenter_point}else{aI=this.effect.leftimage;this.current_size=this.effect.leftsize;this.current_center=this.effect.leftcenter_point}this.setImage(aI)}return !this.effect.duration||aK<this.end_time}});var ar=Date.now();var f=function(){if(N===null){return}var aL=Date.now();var aM=aL-ar;var aK=e();for(var aJ=0,aO=S.length;aJ<aO;++aJ){S[aJ].update(aL,aM,aK)}for(var aJ=0;aJ<ac.length;){var aN=ac[aJ];if(aN.at+M<=aL){if(aN.element.parentNode){aN.element.parentNode.removeChild(aN.element)}ac.splice(aJ,1)}else{if(aN.at<=aL){z(aN.element,1-(aL-aN.at)/M)}++aJ}}if(aE){if(!an){var aI=O();an=b("div",{style:{fontSize:"18px",position:"fixed",bottom:"0",left:"0",zIndex:String(a+9001)}});aI.appendChild(an)}an.innerHTML=Math.round(1000/aM)+" fps"}setTimeout(f,Math.max(F-(aL-Date.now()),0));ar=aL};var M=500;var c=false;var o=true;var g=false;var aE=false;var P=W.abs("");var B=3;var au=0.1;var F=40;var X=500;var l={};var S=[];var ac=[];var ah=null;var N=null;var aq=null;var x=null;var an=null;var H=1;var O=function(){if(!ah){ah=b("div",{id:"browser-ponies"})}if(!ah.parentNode){document.body.appendChild(ah)}return ah};n(document,"mousemove",function(aI){if(!aq){aq={x:aI.clientX,y:aI.clientY}}if(x){x.moveBy({x:aI.clientX-aq.x,y:aI.clientY-aq.y});V(x.dest_position,x.current_position);aI.preventDefault()}aq.x=aI.clientX;aq.y=aI.clientY});n(document,"mouseup",function(){if(x){var aI=x;x=null;if(N!==null){aI.nextBehavior()}}});return{convertPony:function(aM,aW){var aP=m.parse(aM);var a0={baseurl:aW||"",behaviors:[],speeches:[],categories:[]};var aN={};var aU=[];for(var aX=0,aT=aP.length;aX<aT;++aX){var aO=aP[aX];var aI=aO[0].toLowerCase();switch(aI){case"name":a0.name=aO[1];break;case"behavior":var aR={name:aO[1],probability:parseFloat(aO[2]),maxduration:parseFloat(aO[3]),minduration:parseFloat(aO[4]),speed:parseFloat(aO[5]),rightimage:encodeURIComponent(aO[6]),leftimage:encodeURIComponent(aO[7]),movement:aO[8],skip:false,effects:[],auto_select_images:true};if(aO.length>9){if(aO[9]){aR.linked=aO[9]}var aQ=(aO[10]||"").trim();if(aQ){aR.speakstart=aQ}var a1=(aO[11]||"").trim();if(a1){aR.speakend=a1}aR.skip=D(aO[12]);aR.x=parseFloat(aO[13]);aR.y=parseFloat(aO[14]);if(aO[15]){aR.follow=aO[15]}if(aO.length>16){aR.auto_select_images=D(aO[16]);aR.stopped=aO[17];aR.moving=aO[18];if(aO.length>19){aR.rightcenter=u(aO[19]);aR.leftcenter=u(aO[20])}}}a0.behaviors.push(aR);aN[aR.name.toLowerCase()]=aR;break;case"effect":var aS={name:aO[1],behavior:aO[2],rightimage:encodeURIComponent(aO[3]),leftimage:encodeURIComponent(aO[4]),duration:parseFloat(aO[5]),delay:parseFloat(aO[6]),rightloc:aO[7].trim(),rightcenter:aO[8].trim(),leftloc:aO[9].trim(),leftcenter:aO[10].trim(),follow:D(aO[11])};aU.push(aS);break;case"speak":var aK;if(aO.length===2){aK={text:aO[1],skip:false}}else{aK={name:aO[1],text:aO[2].trim(),skip:aO[4]?D(aO[4]):false};var aL=aO[3];if(aL){if(!Array.isArray(aL)){aL=[aL]}if(aL.length>0){aK.files={};for(var aV=0;aV<aL.length;++aV){var aY=aL[aV];var aJ=/(?:\.([^\.]*))?$/.exec(aY)[1];var aZ;if(aJ){aJ=aJ.toLowerCase();aZ=q[aJ]||"audio/x-"+aJ}else{aZ="audio/x-unknown"}if(aZ in aK.files){console.warn(aW+": file type "+aZ+" of speak line "+aK.name+" is not unique.")}aK.files[aZ]=encodeURIComponent(aY)}}}}a0.speeches.push(aK);break;case"categories":a0.categories=a0.categories.concat(aO.slice(1));break;default:console.warn(aW+": Unknown pony setting:",aO)}}if(!("name" in a0)){throw new Error("Pony with following base URL has no name: "+a0.baseurl)}for(var aX=0,aT=aU.length;aX<aT;++aX){var aS=aU[aX];var aR=aS.behavior.toLowerCase();if(!G(aN,aR)){console.warn(aW+": Effect "+aS.name+" of pony "+a0.name+" references non-existing behavior "+aS.behavior)}else{aN[aR].effects.push(aS);delete aS.behavior}}return a0},convertInteractions:function(aI){var aM=m.parse(aI);var aO=[];for(var aK=0,aP=aM.length;aK<aP;++aK){var aN=aM[aK];var aL=false;if(aN.length>4){aL=aN[5].trim().toLowerCase();if(aL==="true"||aL==="all"){aL=true}else{if(aL==="false"||aL=="random"||aL==="any"){aL=false}else{throw new Error("illegal value: "+aN[5])}}}var aJ=aN[3].trim().toLowerCase();if(aJ!=="default"){aJ=parseFloat(aJ)}aO.push({name:aN[0],pony:aN[1],probability:parseFloat(aN[2]),proximity:aJ,targets:aN[4],all:aL,behaviors:aN[6],delay:aN.length>7?parseFloat(aN[7].trim()):0})}return aO},addInteractions:function(aJ){if(typeof(aJ)==="string"){aJ=this.convertInteractions(aJ)}for(var aI=0,aK=aJ.length;aI<aK;++aI){this.addInteraction(aJ[aI])}},addInteraction:function(aI){var aJ=aI.pony.toLowerCase();if(!G(l,aJ)){console.error("No such pony:",aI.pony);return false}return l[aJ].addInteraction(aI)},addPonies:function(aI){for(var aJ=0,aK=aI.length;aJ<aK;++aJ){this.addPony(aI[aJ])}},addPony:function(aI){if(aI.ini){aI=this.convertPony(aI.ini,aI.baseurl)}if(aI.behaviors.length===0){console.error("Pony "+aI.name+" has no behaviors.");return false}var aJ=aI.name.toLowerCase();if(G(l,aJ)){console.error("Pony "+aI.name+" already exists.");return false}l[aJ]=new h(aI);return true},removePonies:function(aI){for(var aJ=0,aK=aI.length;aJ<aK;++aJ){this.removePony(aI[aJ])}},removePony:function(aI){var aJ=aI.toLowerCase();if(G(l,aJ)){l[aJ].unspawnAll();delete l[aJ]}},spawnRandom:function(aM){if(aM===undefined){aM=1}else{aM=parseInt(aM)}if(isNaN(aM)){console.error("unexpected NaN value");return[]}var aK=[];while(aM>0){var aI=Infinity;for(var aJ in l){var aL=l[aJ].instances.length;if(aL<aI){aI=aL}}if(aI===Infinity){console.error("can't spawn random ponies because there are no ponies loaded");break}var aN=[];for(var aJ in l){if(l[aJ].instances.length===aI){aN.push(aJ)}}var aJ=ay(aN);if(this.spawn(aJ)){aK.push(aJ)}--aM}return aK},spawn:function(aJ,aL){var aK=aJ.toLowerCase();if(!G(l,aK)){console.error("No such pony:",aJ);return false}var aI=l[aK];if(aL===undefined){aL=1}else{aL=parseInt(aL);if(isNaN(aL)){console.error("unexpected NaN value");return false}}if(aL>0&&N!==null){aI.preload()}var aN=aL;while(aN>0){var aM=new ao(aI);aI.instances.push(aM);if(N!==null){Z(function(){if(this.pony.instances.indexOf(this)===-1){return}S.push(this);this.img.style.visibility="hidden";O().appendChild(this.img);this.teleport();this.nextBehavior();this.clipToScreen();this.img.style.visibility=""}.bind(aM))}else{S.push(aM)}--aN}return true},unspawn:function(aJ,aL){var aK=aJ.toLowerCase();if(!G(l,aK)){console.error("No such pony:",aJ);return false}var aI=l[aK];if(aL===undefined){aL=aI.instances.length}else{aL=parseInt(aL);if(isNaN(aL)){console.error("unexpected NaN value");return false}}if(aL>=aI.instances.length){aI.unspawnAll()}else{while(aL>0){aI.instances[aI.instances.length-1].unspawn();--aL}}return true},unspawnAll:function(){for(var aI in l){l[aI].unspawnAll()}},clear:function(){this.unspawnAll();l={}},preloadAll:function(){for(var aI in l){l[aI].preload()}},preloadSpawned:function(){for(var aJ in l){var aI=l[aJ];if(aI.instances.length>0){aI.preload()}}},start:function(){if(c){this.preloadAll()}else{this.preloadSpawned()}Z(function(){var aI=O();aI.innerHTML="";for(var aJ=0,aL=S.length;aJ<aL;++aJ){var aK=S[aJ];aK.clear();aK.img.style.visibility="hidden";aI.appendChild(aK.img);aK.teleport();aK.nextBehavior();aK.clipToScreen();aK.img.style.visibility=""}if(N===null){ar=Date.now();N=setTimeout(f,0)}})},timer:function(){return N},stop:function(){if(ah){ah.parentNode.removeChild(ah);ah.innerHTML="";ah=null}an=null;if(N!==null){clearTimeout(N);N=null}},pause:function(){if(N!==null){clearTimeout(N);N=null}},resume:function(){if(c){this.preloadAll()}else{this.preloadSpawned()}Z(function(){if(N===null){ar=Date.now();N=setTimeout(f,0)}})},setInterval:function(aI){aI=parseInt(aI);if(isNaN(aI)){console.error("unexpected NaN value for interval")}else{if(F!==aI){F=aI}}},getInterval:function(){return F},setFps:function(aI){this.setInterval(1000/parseFloat(aI))},getFps:function(){return 1000/F},setInteractionInterval:function(aI){aI=parseFloat(aI);if(isNaN(aI)){console.error("unexpected NaN value for interaction interval")}else{X=aI}},getInteractionInterval:function(){return X},setSpeakProbability:function(aI){aI=parseFloat(aI);if(isNaN(aI)){console.error("unexpected NaN value for speak probability")}else{au=aI}},getSpeakProbability:function(){return au},setVolume:function(aI){aI=parseFloat(aI);if(isNaN(aI)){console.error("unexpected NaN value for volume")}else{if(aI<0||aI>1){console.error("volume out of range",aI)}else{H=aI}}},getVolume:function(){return H},setBaseUrl:function(aI){P=aI},getBaseUrl:function(){return P},setSpeed:function(aI){B=parseFloat(aI)},getSpeed:function(){return B},setAudioEnabled:function(aI){if(typeof(aI)==="string"){try{aI=D(aI)}catch(aJ){console.error("illegal value for audio enabled",aI,aJ);return}}else{aI=!!aI}if(g!==aI&&aI){g=aI;if(c){this.preloadAll()}else{this.preloadSpawned()}}else{g=aI}},isAudioEnabled:function(){return g},setShowFps:function(aI){if(typeof(aI)==="string"){try{aE=D(aI)}catch(aJ){console.error("illegal value for show fps",aI,aJ);return}}else{aE=!!aI}if(!aE&&an){if(an.parentNode){an.parentNode.removeChild(an)}an=null}},isShowFps:function(){return aE},setPreloadAll:function(aI){if(typeof(aI)==="string"){try{c=D(aI)}catch(aJ){console.error("illegal value for preload all",aI,aJ);return}}else{c=!!aI}},isPreloadAll:function(){return c},setShowLoadProgress:function(aI){if(typeof(aI)==="string"){try{o=D(aI)}catch(aJ){console.error(aJ);return}}else{o=!!aI}},isShowLoadProgress:function(){return o},getFadeDuration:function(){return M},setFadeDuration:function(aI){M=parseFloat(aI)},running:function(){return N!==null},ponies:function(){return l},loadConfig:function(aJ){if("baseurl" in aJ){this.setBaseUrl(aJ.baseurl)}if("speed" in aJ){this.setSpeed(aJ.speed)}if("speakProbability" in aJ){this.setSpeakProbability(aJ.speakProbability)}if("volume" in aJ){this.setVolume(aJ.volume)}if("interval" in aJ){this.setInterval(aJ.interval)}if("fps" in aJ){this.setFps(aJ.fps)}if("interactionInterval" in aJ){this.setInteractionInterval(aJ.interactionInterval)}if("audioEnabled" in aJ){this.setAudioEnabled(aJ.audioEnabled)}if("showFps" in aJ){this.setShowFps(aJ.showFps)}if("preloadAll" in aJ){this.setPreloadAll(aJ.preloadAll)}if("showLoadProgress" in aJ){this.setShowLoadProgress(aJ.showLoadProgress)}if("fadeDuration" in aJ){this.setFadeDuration(aJ.fadeDuration)}if(aJ.ponies){this.addPonies(aJ.ponies)}if(aJ.interactions){this.addInteractions(aJ.interactions)}if(aJ.spawn){for(var aI in aJ.spawn){this.spawn(aI,aJ.spawn[aI])}}if("spawnRandom" in aJ){this.spawnRandom(aJ.spawnRandom)}if(aJ.onload){if(Array.isArray(aJ.onload)){for(var aK=0,aL=aJ.onload.length;aK<aL;++aK){Z(aJ.onload[aK])}}else{Z(aJ.onload)}}if(aJ.autostart&&N===null){this.start()}},dumpConfig:function(){var aK={};aK.baseurl=this.getBaseUrl();aK.speed=this.getSpeed();aK.speakProbability=this.getSpeakProbability();aK.volume=this.getVolume();aK.interval=this.getInterval();aK.fps=this.getFps();aK.interactionInterval=this.getInteractionInterval();aK.audioEnabled=this.isAudioEnabled();aK.showFps=this.isShowFps();aK.preloadAll=this.isPreloadAll();aK.showLoadProgress=this.isShowLoadProgress();aK.fadeDuration=this.getFadeDuration();aK.spawn={};for(var aJ in l){var aI=l[aJ];if(aI.instances.length>0){aK.spawn[aI.name]=aI.instances.length}}return aK},togglePoniesToBackground:function(){if(typeof(toggleBrowserPoniesToBackground)==="undefined"){alert("This website does not support bringing Browser Ponies to the background.")}else{try{toggleBrowserPoniesToBackground()}catch(aI){alert("Error toggling Browser Ponies to the background:\n\n"+aI.name+": "+aI.message)}}},Util:{setOpacity:z,extend:V,tag:V(b,{add:s}),has:G,format:r,partial:d,observe:n,stopObserving:v,IE:aj,Opera:av,Gecko:t,HasAudio:w,BaseZIndex:a,onload:Z,onprogress:aa,$:am,randomSelect:ay,dataUrl:y,escapeXml:aH,Base64:ax,PonyINI:m,getOverlay:O,parseBoolean:D,parsePoint:u,URL:W}}})();if(typeof(BrowserPoniesConfig)!=="undefined"){BrowserPonies.loadConfig(BrowserPoniesConfig);if(BrowserPoniesConfig.oninit){(function(){if(Array.isArray(BrowserPoniesConfig.oninit)){for(var a=0,b=BrowserPoniesConfig.oninit.length;a<b;++a){BrowserPoniesConfig.oninit[a]()}}else{BrowserPoniesConfig.oninit()}})()}};